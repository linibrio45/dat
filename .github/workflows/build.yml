name: FastAPI via Cloudflared

on:
  workflow_dispatch:

jobs:
  run-fastapi-service:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install fastapi "uvicorn[standard]" uvloop httptools

      - name: Create FastAPI app file
        run: |
          cat << 'EOF' > main.py
          from fastapi import FastAPI

          app = FastAPI()

          @app.get("/")
          async def main():
              return {"message": "Hello, World!"}
          EOF

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Run Services and Get Public URL
        # Устанавливаем таймаут для всего шага на 10 минут, чтобы он не упал раньше времени
        timeout-minutes: 10
        run: |
          # Запускаем Uvicorn в фоне
          uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4 --loop uvloop --http httptools &
          # Сохраняем PID процесса Uvicorn, чтобы потом проверить, что он жив
          UVICORN_PID=$!
          
          # Даем Uvicorn время на старт
          sleep 5
          
          # Запускаем Cloudflared в фоне, используя нативный логгер
          cloudflared tunnel --url http://localhost:8000 --no-autoupdate --logfile cloudflared.log &
          # Сохраняем PID процесса Cloudflared
          CLOUDFLARED_PID=$!
          
          echo "Waiting for Cloudflared URL... (up to 90 seconds)"
          
          # Умный цикл ожидания
          for i in {1..45}; do
            # Проверяем, не упали ли наши процессы
            if ! kill -0 $UVICORN_PID 2>/dev/null; then
              echo "::error::Uvicorn process has died."
              exit 1
            fi
            if ! kill -0 $CLOUDFLARED_PID 2>/dev/null; then
              echo "::error::Cloudflared process has died. See log:"
              cat cloudflared.log
              exit 1
            fi
          
            # Ищем URL в логе
            URL=$(grep -o 'https://.*\.trycloudflare.com' cloudflared.log)
            if [ -n "$URL" ]; then
              echo "===================================================================="
              echo "✅ Your public URL is: $URL"
              echo "===================================================================="
              # Запускаем бесконечный процесс, чтобы воркфлоу не завершился
              # Теперь, когда URL получен, мы можем "зависнуть"
              echo "Server is running. Workflow will not exit."
              tail -f /dev/null
              exit 0
            fi
            
            echo "Still waiting... (attempt $i/45)"
            sleep 2
          done
          
          # Если мы вышли из цикла, значит URL не появился за 90 секунд
          echo "::error::Failed to get Cloudflared URL within 90 seconds."
          echo "Dumping cloudflared.log:"
          cat cloudflared.log
          exit 1
